#!/bin/sh
set -e

# Install all dependencies
echo "### Install all dependencies..."
apk add --no-cache tini curl ca-certificates gettext $SETUP_DEPENDENCIES_SETUP $SETUP_DEPENDENCIES_CONFIG $SETUP_DEPENDENCIES_RUNTIME


# Setup export file
echo "### Setup export file..."
chmod 766 /etc/exports

# Install extra binaries
echo "### Install extra binaries..."
KUBECTL_LATEST=$(curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt)
curl -fsSL https://storage.googleapis.com/kubernetes-release/release/${KUBECTL_LATEST}/bin/linux/amd64/kubectl -o ${BUILD_PATHS_BINARIES_FOLDER}/kubectl
curl -fsSL https://raw.githubusercontent.com/ehough/docker-nfs-server/master/entrypoint.sh -o ${BUILD_PATHS_BINARIES_FOLDER}/nfsd
sed -i 's/#!\/usr\/bin\/env bash/#!\/bin\/bash/g' ${BUILD_PATHS_BINARIES_FOLDER}/nfsd
echo "rpc_pipefs  /var/lib/nfs/rpc_pipefs  rpc_pipefs  defaults  0  0" >> /etc/fstab
echo "nfsd        /proc/fs/nfsd            nfsd        defaults  0  0" >> /etc/fstab
chmod -R +x ${BUILD_PATHS_BINARIES_FOLDER}


# Remove unecessary dependencies
echo "### Remove unecessary dependencies..."
echo "$SETUP_DEPENDENCIES_SETUP" | tr ' ' "\n" > /tmp/A
echo "$SETUP_DEPENDENCIES_CONFIG $SETUP_DEPENDENCIES_RUNTIME" | tr ' ' "\n"  > /tmp/B
UNNECESSARY_DEPENDENDCY_SETUP=$( grep -Fxv -f /tmp/B /tmp/A | xargs )
rm -f /tmp/A /tmp/B
apk del --no-cache $UNNECESSARY_DEPENDENDCY_SETUP



exit 0