#!/bin/sh

# exit if a command fails
set -e

# Add Bash completitions
echo "### Add Bash completitions..."
BUILD_PATHS_BASH_COMPLETITIONS=$HOME/.bash_completion.d
mkdir -p ${BUILD_PATHS_BASH_COMPLETITIONS}/
curl -fsSl https://raw.githubusercontent.com/netz98/n98-magerun/master/res/autocompletion/bash/n98-magerun.phar.bash -o ${BUILD_PATHS_BASH_COMPLETITIONS}/n98-magerun
curl -fsSl https://raw.githubusercontent.com/iArren/composer-bash-completion/master/composer -o ${BUILD_PATHS_BASH_COMPLETITIONS}/composer
curl -fsSl https://raw.githubusercontent.com/wp-cli/wp-cli/master/utils/wp-completion.bash -o ${BUILD_PATHS_BASH_COMPLETITIONS}/wp-cli
DOCKER_COMPOSE_LATEST_VERSION=$(git-get-latest-release https://github.com/docker/compose/ )
curl -fsSl https://raw.githubusercontent.com/docker/compose/${DOCKER_COMPOSE_LATEST_VERSION}/contrib/completion/bash/docker-compose -o ${BUILD_PATHS_BASH_COMPLETITIONS}/docker-compose
minikube completion bash > ${BUILD_PATHS_BASH_COMPLETITIONS}/minikube
kubectl completion bash > ${BUILD_PATHS_BASH_COMPLETITIONS}/kubectl
kops completion bash > ${BUILD_PATHS_BASH_COMPLETITIONS}/kops
helm completion bash > ${BUILD_PATHS_BASH_COMPLETITIONS}/helm
kompose completion bash > ${BUILD_PATHS_BASH_COMPLETITIONS}/kompose

# Configurations
echo "### Configurations..."
gcloud config set core/disable_usage_reporting true
gcloud config set component_manager/disable_update_check true
gcloud config set metrics/environment github_docker_image

# Configure nfs exports
echo "### Configure nfs exports..."
echo "" > /etc/exports
echo "${BUILD_PATHS_BINARIES_FOLDER} $CONFIG_NFS_IP_PERMITTED(rw,sync,no_subtree_check,no_auth_nlm,insecure,no_root_squash)" >> /etc/exports
echo "${HOME} $CONFIG_NFS_IP_PERMITTED(rw,sync,no_subtree_check,no_auth_nlm,insecure,no_root_squash)" >> /etc/exports
/usr/sbin/exportfs -rv



exit 0